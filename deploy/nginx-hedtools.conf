# Nginx configuration for hedtools.ucsd.edu
# Add this to your existing Nginx configuration

# HED-BOT API Backend
location /hed-bot {
    # Strip /hed-bot prefix when proxying to backend
    rewrite ^/hed-bot(/.*)$ $1 break;
    rewrite ^/hed-bot$ / break;

    # Proxy to Docker container
    proxy_pass http://127.0.0.1:33427;

    # HTTP version and headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_cache_bypass $http_upgrade;

    # Timeouts for long-running requests (LLM inference can be slow)
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Buffer settings for streaming responses
    proxy_buffering off;
    proxy_request_buffering off;

    # CORS headers (FastAPI handles CORS, but can add extra layer here)
    # Only allow requests from hed-bot.pages.dev
    if ($http_origin ~* "^https://hed-bot\.pages\.dev$") {
        add_header 'Access-Control-Allow-Origin' $http_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
    }

    # Handle preflight OPTIONS requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' $http_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;
        add_header 'Access-Control-Max-Age' 3600 always;
        add_header 'Content-Length' 0;
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        return 204;
    }
}

# Health check endpoint (no authentication, for monitoring)
location /hed-bot/health {
    proxy_pass http://127.0.0.1:33427/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;

    # Allow health checks from anywhere (monitoring tools, etc.)
    add_header 'Access-Control-Allow-Origin' '*' always;

    # Don't log health checks (reduce noise)
    access_log off;
}

# Optional: Rate limiting to prevent abuse
# Add this in the http block if needed:
# limit_req_zone $binary_remote_addr zone=hed_bot_limit:10m rate=60r/m;
#
# Then add inside the location block:
# limit_req zone=hed_bot_limit burst=10 nodelay;
